<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
		<title>test events</title>
		<!--	共用文件，不要修改	start	-->
		<link href="qunit/qunit/qunit.css" rel="stylesheet" type="text/css" />
		<script type="text/javascript" src="../src/base.js"></script>
		<script type="text/javascript" src="qunit/qunit/qunit.js"></script>
		<!--	共用文件，不要修改	end	-->
		<script type="text/javascript">
			/*global ok, console, k, kampfer, test, QUnit*/
			kampfer.require('events');
		</script>
	</head>
	<body>
		<!--	共用文件，不要修改	start	-->
		<h1 id="qunit-header">QUnit for events</h1>
		<h2 id="qunit-banner"></h2>
		<div id="qunit-testrunner-toolbar"></div>
		<h2 id="qunit-userAgent"></h2>
		<ol id="qunit-tests"></ol>
		<!--	共用文件，不要修改	end	-->

		<script type="text/javascript">
		/*global kampfer, k, ok, test, QUnit, module, window*/
			QUnit.config.reorder = false;
			function $(id) {
				return document.getElementById(id);
			}

			test('addListener有效性检查', function() {
				var input = document.createElement('input');

				var triggered = [];

				kampfer.events.addListener(input, 'dbclick', function(event) {
					triggered.push(event.type);
				});
				kampfer.events.addListener(input, ['click', 'focus'], function(event) {
					triggered.push(event.type);
				});

				kampfer.events.dispatch(input, 'dbclick');
				kampfer.events.dispatch(input, ['click', 'focus']);

				ok(triggered.join('->') === 'dbclick->click->focus', 'input dbclick->click->focus');
			});

			test('addListener data 操作检查', function() {
				var div = document.createElement('div');
					obj = {foo:1};

				function check(obj) {
					ok(!obj[kampfer.expando], '初始状态expando不存在');

					var handler = function() {};
					kampfer.events.addListener(obj, 'click', handler);

					ok(obj[kampfer.expando], '绑定事件生成expando');

					var events = kampfer.data.getDataInternal(obj, 'events');
					ok(events, '绑定事件生成了events cache对象');
					ok(events.proxy, 'events.proxy存在');
					ok(events.listeners, 'events.listeners');
					ok(events.listeners.click[0].listener === handler, 'handler被绑定');
				}

				check(div);
				check(obj);
			});

			test('dispatch 自定义参数传递检查', function() {
				var div = document.createElement('div');
				var bar = {};

				kampfer.events.addListener(div, 'click', function(event) {
					ok(arguments[1] === 'foo', 'foo');
					ok(arguments[2] === 'baz', 'baz');
					ok(arguments[3] === bar, 'bar');
				});

				kampfer.events.dispatch(div, 'click', 'foo', 'baz', bar);
			});

			test('dispatch event检查', function() {
				var div = document.createElement('div');
				var obj = {};
				var eventType = 'click';

				var check = function(event) {
					equal(event.type, eventType, 'event.type check');
				};

				kampfer.events.addListener(div, eventType, function(event) {
					check(event);
					strictEqual(event.target, div, 'event.targt check');
					strictEqual(event.currentTarget, div, 'event.currentTarge check');
				});
				kampfer.events.addListener(obj, eventType, function(event) {
					check(event);
					strictEqual(event.target, obj, 'event.targt check');
					strictEqual(event.currentTarget, obj, 'event.currentTarge check');
				});

				kampfer.events.dispatch(div, 'click');
				kampfer.events.dispatch(obj, 'click');
			});

			test('dispatch this检查', function() {
				var div = document.createElement('div');

				kampfer.events.addListener(div, 'click', function(event) {
					strictEqual(this, div, 'this check');
				});

				kampfer.events.dispatch(div, 'click');
			});

			//chrome firefox通过, ie8无法通过
			test('通过elem[type]触发addEventListener/attachEvent绑定的事件', function() {
				var div = document.createElement('div');
				var handler = function() {
					ok(true, 'div.click() checked!');
				};

				if(div.addEventListener) {
					div.addEventListener('click', handler, false);
				} else if(div.attachEvent) {
					div.attachEvent('onclick', handler, false);
				}

				div.click();
			});
		</script>
	</body>
</html>